try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="a25327fa-dcee-4ee1-8e23-d1f7e00cbd29",e._sentryDebugIdIdentifier="sentry-dbid-a25327fa-dcee-4ee1-8e23-d1f7e00cbd29")}catch(e){}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9067],{16304:(e,t,n)=>{n.d(t,{V:()=>i});var a=n(7620),s=n(88769),l=n(24423);function i(e,t,n){let i=(0,l.Gu)(),{clearAllFeatures:r}=(0,s.Bk)();(0,a.useLayoutEffect)(()=>(!n&&t.length>0&&i(e,t),()=>{r(),n&&i(e,[])}),[e,t,n,i,r])}},71302:(e,t,n)=>{n.r(t),n.d(t,{PaymentVerificationModal:()=>g});var a=n(54568),s=n(74813),l=n(64328),i=n(45054),r=n(77223),o=n(26819),u=n(3075),d=n(4869),c=n(7620),m=n(59666),f=n(48579),v=n(89060);function g(){let[e,t]=(0,c.useState)(!1),n=(0,s.st)(),{activeOrganization:g}=(0,l.YL)(),{addError:p,addSuccess:_}=(0,i.Y)(),y=(0,r.ib)(),h=(0,d.useQueryClient)(),{shouldShowModal:x,dismissReminder:j}=(0,v.F)(),w=(0,f.Si)({onSuccess:async e=>{try{var s,l;let t=await y;if(!t)throw Error("Stripe failed to initialize");let i=await t.retrieveSetupIntent(e.clientSecret);if(i.error)throw Error(i.error.message);if((null==(s=i.setupIntent)?void 0:s.status)==="requires_action"){let n=await t.handleNextAction({clientSecret:e.clientSecret});if(n.error)throw Error(n.error.message)}else(null==(l=i.setupIntent)?void 0:l.status)==="succeeded"&&n.track({event_key:"payment_modal_open",organization_id:null==g?void 0:g.uuid,action:"verify_3ds_success_frictionless"});await h.invalidateQueries({queryKey:["check-3ds-required",null==g?void 0:g.uuid]}),n.track({event_key:"payment_modal_open",organization_id:null==g?void 0:g.uuid,action:"verify_3ds_success"}),_((0,a.jsx)(m.A,{defaultMessage:"Payment method verified successfully",id:"vRXoCh/o7W"})),n.track({event_key:"payment_modal_open",organization_id:null==g?void 0:g.uuid,action:"verify_3ds_success"})}catch(e){p(e instanceof Error&&"PAYMENT_VERIFICATION_FAILED"===e.message?(0,a.jsx)(m.A,{defaultMessage:"Payment verification failed",id:"9RpX03Q2ky"}):e instanceof Error?e.message:(0,a.jsx)(m.A,{defaultMessage:"Payment verification failed. Please try again.",id:"0kXa3Rf5bZ"}),{error:e}),n.track({event_key:"payment_modal_open",organization_id:null==g?void 0:g.uuid,action:"verify_3ds_error",error_message:e instanceof Error?e.message:"Unknown error"})}finally{t(!1)}},onError:e=>{t(!1),p((0,a.jsx)(m.A,{defaultMessage:"Failed to start verification process. Please try again.",id:"3dT/r8rV5S"}),{error:e}),n.track({event_key:"payment_modal_open",organization_id:null==g?void 0:g.uuid,action:"verify_3ds_api_error",error_message:e.message})}}),b=()=>{j()};return x?(0,a.jsx)(u.aF,{isOpen:x,onClose:b,modalSize:"md",hasCloseButton:!0,title:(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsx)(o.E,{color:"secondary",size:"lg",children:(0,a.jsx)(m.A,{defaultMessage:"Action Required",id:"jWgFDt2Ifa"})})}),children:(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)("h2",{className:"text-3xl font-medium text-text-100 mb-3",children:(0,a.jsx)(m.A,{defaultMessage:"Verify your payment method",id:"epYApo9bIj"})}),(0,a.jsx)("p",{className:"text-text-200 mb-6",children:(0,a.jsx)(m.A,{defaultMessage:"To comply with European security regulations, we need to verify your payment method using a quick one-time security process. This ensures your subscription remains active and secure.",id:"K0hDpiUx0B"})}),(0,a.jsxs)("div",{className:"flex flex-col gap-2 mt-6",children:[(0,a.jsx)(u.yl,{onClick:()=>{t(!0),n.track({event_key:"payment_modal_open",organization_id:null==g?void 0:g.uuid,action:"verify_3ds_start"});let e=window.location.href;w.mutate({return_url:e})},loading:e,className:"w-full",children:(0,a.jsx)(m.A,{defaultMessage:"Verify now",id:"t28SE7zKVA"})}),(0,a.jsx)(u.yl,{variant:"secondary",onClick:b,className:"w-full",children:(0,a.jsx)(m.A,{defaultMessage:"Remind me later",id:"c4hRLOnYpQ"})})]})]})}):null}},89060:(e,t,n)=>{n.d(t,{F:()=>u});var a=n(74813),s=n(64328),l=n(68067),i=n(7620),r=n(48579);let o="payment-verification-reminder-dismissed";function u(){let{activeOrganization:e}=(0,s.YL)(),t=(0,a.st)(),[n,u]=(0,i.useState)(!1),{value:d}=(0,l.fS)("show_3ds_modal"),{data:c}=(0,r.PI)(d);return(0,i.useEffect)(()=>{var n;let a=localStorage.getItem(o);if(a){let e=new Date(a).getTime();if(new Date().getTime()-e<864e5)return void u(!1)}let s=d&&null!=(n=null==c?void 0:c.requires_3ds_verification)&&n;u(s),s&&t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,modal_type:"3ds_verification_required"})},[d,c,t,e]),{shouldShowModal:n,dismissReminder:(0,i.useCallback)(()=>{let n=new Date().toISOString();localStorage.setItem(o,n),u(!1),t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,action:"3ds_verification_dismissed",dismissed_at:n})},[t,e])}}},99067:(e,t,n)=>{n.d(t,{ChatClientPage:()=>Y});var a=n(54568),s=n(19736),l=n(47592),i=n(18849),r=n(58841),o=n(64328),u=n(41473);function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;if(e.length<=t)return e;let n=Math.ceil(t/2);return"".concat(e.substring(0,n),"\n\n  [...]\n\n  ").concat(e.substring(e.length-n))}var c=n(7620),m=n(10369),f=n(96614),v=n(68704),g=n(98944),p=n(27541),_=n(55188),y=n(59294),h=n(24423),x=n(98324),j=n(69351),w=n(74813),b=n(96547),k=n(50571),S=n(35580),C=n(73648),A=n(23812),M=n(3075),E=n(73996),I=n(59666),N=n(45271),T=n(99411),z=n(4899),O=n(72253);function R(e){let{isModalOpen:t,currentTool:n,currentToolInput:s,currentServer:l,handleDeny:i,handleAllow:r,handleAlwaysAllow:o}=e,{isExpanded:u,setIsExpanded:d,snappyTransition:c}=(0,O.a)(!1);if(n)return(0,a.jsxs)(M.aF,{isOpen:t,onClose:()=>i(),autoCloseOnFocusOut:!1,closeOnEscapeKeydown:!1,modalSize:"lg",title:(0,a.jsx)(I.A,{defaultMessage:"Claude would like to use this tool",id:"PwE/s/W1AC"}),children:[(0,a.jsx)("div",{className:"mt-4"}),(0,a.jsx)(T.sH,{isStreaming:!1,isExpanded:u,setIsExpanded:d,isFirstBlockOfMessage:!0,isLastBlockOfMessage:!0,text:(0,a.jsx)(E.fI,{className:"!py-0",children:(0,a.jsxs)("div",{className:"flex gap-4 items-center",children:[(0,a.jsx)(N.z,{size:42,imageSize:24,type:(null==l?void 0:l.iconType)||"favicon",src:null==l?void 0:l.iconSrc,name:(null==l?void 0:l.name)||n.name}),(0,a.jsxs)("div",{className:"flex flex-col py-1",children:[(0,a.jsx)("div",{className:"text-sm text-text-400 font-mono",children:n.name}),(null==l?void 0:l.name)&&(0,a.jsx)("span",{className:"font-medium text-[0.9rem] pt-1",children:l.name})]})]})}),className:"!h-auto",children:(0,a.jsx)(T.NG,{isExpanded:u,snappyTransition:c,isScrollable:!0,children:(0,a.jsx)(z.L,{input:s?JSON.parse(s):""})})}),(0,a.jsxs)("div",{className:"flex flex-col p-4 gap-4 bg-bg-300 my-4 rounded-lg border-0.5 border-border-300",children:[(0,a.jsx)("p",{className:"font-medium",children:(0,a.jsx)(I.A,{defaultMessage:"Review each action carefully before approving",id:"IaQzFuy2mt"})}),(0,a.jsx)("p",{children:(0,a.jsx)(I.A,{defaultMessage:"Claude cannot guarantee the security or privacy practices of third-party integrations.",id:"3gyayAmXQv"})})]}),(0,a.jsx)(M.vW,{className:"flex justify-between",children:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[o&&(0,a.jsx)(A.$,{onClick:o,children:(0,a.jsx)(I.A,{defaultMessage:"Allow always",id:"F8zkKBCp6U"})}),(0,a.jsx)(A.$,{onClick:r,autoFocus:!0,children:(0,a.jsx)(I.A,{defaultMessage:"Allow once",id:"O2tb5KUxpc"})})]}),(0,a.jsx)(A.$,{onClick:i,variant:"outline",children:(0,a.jsx)(I.A,{defaultMessage:"Decline",id:"pvtgR26QWY"})})]})})]})}var D=n(1613),F=n(45054),P=n(16178),L=n(80688),U=n(8019),q=n(4869);function B(e){var t,n,l;let{conversation:i,conversationUuid:r,chatInputDefaultMessage:A}=e,M=(0,p.useRouter)(),{incognitoModeEnabled:E}=(0,_.S)(),{data:I,isLoading:N,isPlaceholderData:T}=(0,s.Bq)(r,{suppressError:!0}),z=(0,c.useMemo)(()=>{if((null==I?void 0:I.danglingHumanMessages)&&I.danglingHumanMessages.length>0)return I.danglingHumanMessages[I.danglingHumanMessages.length-1]},[I]),O=null==I?void 0:I.project_uuid,B=(0,h.gq)(),K=(0,h.xw)(r),{changeDisplayedConversationPath:Q}=(0,v.G)(),{onInvokeTool:Y,isModalOpen:V,currentTool:G,currentToolInput:H,currentServer:W,handleAllow:X,handleDeny:Z,handleAlwaysAllow:$}=function(e){let{conversationUuid:t}=e,n=(0,j.M)(),{track:a}=(0,w.st)(),[s,l]=(0,c.useState)(!1),[i,r]=(0,c.useState)(null),[o,u]=(0,c.useState)(null),[d,m]=(0,c.useState)(void 0),[f,v]=(0,c.useState)(null),[g,p]=(0,c.useState)(null),[_,y]=(0,c.useState)(void 0),[h,x]=(0,c.useState)(!1),A=(0,b.p9)(),M=(0,k.HJ)(),{toggleMcpToolAlwaysApproved:E}=(0,k.es)(),{getApprovalSetting:I}=(0,k.BN)(),{mutate:N}=(0,b.p4)(t),T=(0,c.useCallback)(async(e,t,a,s,i,o,d)=>{if(M)return;let c=(0,S.pK)(t),f=null==c?void 0:c.tool,g=null==c?void 0:c.server;if(!f)return n(e,t,a,s,i);if(A&&(null==g?void 0:g.type)==="remote")return o?new Promise(e=>{r(t),m(g),u(f),v(a),p(s),x(o.includes("always")),y(d),l(!0),e()}):void 0;let _=I(null==g?void 0:g.name,f);return"never"===_?n(e,t,a,s,i):new Promise(e=>{r(t),x("ask"===_),m(g),u(f),v(a),p(s),l(!0),e()})},[n,I,A,M]),z=(0,c.useCallback)(()=>{l(!1),i&&null!==f&&null!==g&&(_?N({tool_use_id:f,is_approved:!0}):n(t,i,f,g))},[t,i,f,g,n,_,N]),O=(0,c.useCallback)(()=>{if(l(!1),i&&null!==f&&null!==g)if(_)N({tool_use_id:f,is_approved:!1});else{var e;n(t,i,f,g,{overriddenResult:{content:[{type:"text",text:"The user has chosen to disallow the tool call."}],is_error:!0}}),a({event_key:"mcp.tools.called",result:"disallowed",argument_count:Object.keys(null!=(e=(0,C.p)(g))?e:{}).length})}},[t,i,f,g,n,a,_,N]),R=(0,c.useCallback)(()=>{h&&(o&&!_&&E(o.alwaysApprovedKey,!0),l(!1),i&&null!==f&&null!==g&&(_&&N({tool_use_id:f,is_approved:!0,approval_key:_,approval_option:"always"}),n(t,i,f,g)))},[t,i,o,f,g,n,E,h,_,N]);return{onInvokeTool:T,isModalOpen:s,currentTool:o,currentServer:d,currentToolInput:g,handleAllow:z,handleDeny:O,handleAlwaysAllow:h?R:void 0}}({conversationUuid:r}),J=(0,f.Z3)(r),ee=(0,j.n)(null==I||null==(t=I.settings)?void 0:t.enabled_mcp_tools,null==i?void 0:i.project_uuid),{markFirstTokenReceived:et}=(0,y.B)(),en=(0,c.useCallback)(()=>{var e;let t;et({model:J,integrations:(e=null==I?void 0:I.settings,t="",e?(Object.entries(e).forEach(e=>{let[n,a]=e;"enabled_mcp_tools"===n&&!("object"!=typeof a||null===a||Array.isArray(a))&&Object.values(a).every(e=>"boolean"==typeof e)?Object.entries(a).forEach(e=>{let[n,a]=e;a&&(t+=n+",")}):"boolean"==typeof a&&a&&(t+=n+",")}),t.slice(0,-1)):t)})},[et,J,null==I?void 0:I.settings]);(0,c.useEffect)(()=>{if(!E||!(null==I?void 0:I.updated_at))return;let e=()=>{let e=new Date(I.updated_at).getTime();(Date.now()-e)/36e5>=47&&M.push("/new")};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[E,null==I?void 0:I.updated_at,M]);let[ea,es]=(0,c.useState)(),el=(0,c.useCallback)(e=>{es(e)},[es]),[ei,er]=(0,c.useState)(0),eo=(0,c.useCallback)(e=>{er(e)},[]),eu=(0,f.Gw)(r,O,Y,ee,en,B,eo),ed=(0,f.SL)(r,O,Y,ee,ea,en,B,eo),{mutate:ec}=(0,s.lj)(r),em=eu.isStreaming||ed.isStreaming,ef=(0,c.useCallback)(async e=>(er(0),eu.runStream(e)),[eu]),ev=(0,c.useCallback)(async(e,t,n,a)=>(er(0),ed.runStream(e,t,n,a)),[ed]);!function(e,t){let[n,a]=(0,c.useState)(!1),{activeOrganization:l}=(0,o.YL)(),i=(0,m.A)(),r=e?e.uuid:"",{mutate:f}=(0,s.HI)(r),{mutate:v,error:g}=(0,s.OZ)(r),p=(0,c.useRef)(!1);(0,c.useEffect)(()=>{var t;if(!g||(null==e?void 0:e.name))return;let n=(null==e||null==(t=e.chat_messages)?void 0:t[0])?(0,u.C)(e.chat_messages[0]):"";if(n){if(p.current)return;let e=n.slice(0,30),t=n.length>30?"...":"";p.current=!0,f({name:"".concat(e).concat(t)})}},[g,e,f]),(0,c.useEffect)(()=>{if(t||n||(null==e?void 0:e.name))return;let s=null==e?void 0:e.chat_messages;if(!s||s.length<2||0===(0,u.C)(s[1]).length)return;let i=["Message 1:",d((0,u.C)(s[0])),"Message 2:",d((0,u.C)(s[1]))].join("\n\n");l&&(a(!0),v({message_content:i,recent_titles:[]}))},[t,n,e,l,v,i])}(I,em);let eg=(0,c.useCallback)(async(e,t)=>{var n,a;await ef({prompt:t,attachments:e.attachments,files:null!=(a=e.files_v2)?a:e.files,syncSources:e.sync_sources,parent_message_uuid:e.parent_message_uuid,personalized_style:ea,compass_mode:null==(n=e.metadata)?void 0:n.compass_mode})},[ef,ea]),ep=(0,c.useCallback)((e,t)=>{Q(r,e,t,e=>ec({current_leaf_message_uuid:e}))},[Q,r,ec]),{hasPendingUserMessage:e_,isCompletionStatusLoading:ey,stopPendingRecovery:eh}=function(e){let{conversationUuid:t,pendingUserMessage:n,chatConversationTree:a,isLoading:s}=e,l=(0,c.useRef)(!1),i=(0,c.useRef)(null),r=(0,c.useRef)(null),u=(0,c.useRef)(null),d=(0,h.uQ)(),m=(0,h.Gu)(),v=(0,h.RR)(),{activeOrganization:g}=(0,o.YL)(),{addError:p}=(0,F.Y)(),{setFailedStreamRetryData:_}=(0,f.x)(),y=(0,q.useQueryClient)(),[x,j]=(0,c.useState)(!1),[w,b]=(0,c.useState)(!1),{data:k,isLoading:S}=(0,D.Sk)((null==g?void 0:g.uuid)&&t&&n?"/api/organizations/".concat(g.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=false"):"",{enabled:!!(null==g?void 0:g.uuid)&&!!t&&!s&&!!n&&!l.current,staleTime:0,refetchOnWindowFocus:!1}),C=(0,c.useCallback)(()=>{var e;n&&_({prompt:(null!=(e=n.content)?e:[]).filter(e=>"text"===e.type).map(e=>e.text).join(""),attachments:n.attachments||[],files:n.files_v2||[]})},[n,_]),A=(0,c.useCallback)(()=>{r.current&&(r.current.abort(),r.current=null),u.current&&(clearTimeout(u.current),u.current=null)},[]),M=(0,c.useCallback)(()=>{let e=v(t),a=e.filter(e=>e.uuid!==(null==n?void 0:n.uuid)&&e.uuid!==i.current);a.length!==e.length&&m(t,a)},[t,v,null==n?void 0:n.uuid,m]),E=(0,c.useCallback)((e,t)=>{M(),C();let n=e||"Message failed. Please try again.";p(n,{error:new P.LG(n,t||"completion_error",500,{})})},[M,C,p]),I=(0,c.useCallback)(()=>{if(!(null==g?void 0:g.uuid)||!t||!n)return;b(!0),r.current=new AbortController;let e=0,a=async()=>{var n,s,l;if(e>=10||(null==(n=r.current)?void 0:n.signal.aborted))return void b(!1);e++;try{let e=await fetch("/api/organizations/".concat(g.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=true"),{method:"GET",credentials:"include",signal:null==(s=r.current)?void 0:s.signal});if(!e.ok)return void b(!1);let n=await e.json();n.is_pending?(null==(l=r.current)?void 0:l.signal.aborted)||(u.current=setTimeout(()=>void a(),2e3)):(j(!1),b(!1),M(),n.is_error&&E(n.error_detail,n.error_code),await y.invalidateQueries({queryKey:[L.fC,{orgUuid:g.uuid},{uuid:t}]}))}catch(e){b(!1)}};a()},[null==g?void 0:g.uuid,t,n,y,E,M]);return(0,c.useEffect)(()=>{if(!s&&!l.current&&n&&a&&void 0!==k){if(l.current=!0,k.is_error)E(k.error_detail,k.error_code);else if(k.is_pending){j(!0);let e=(0,U.b)();i.current=e;let a={uuid:e,sender:"assistant",content:[{type:"text",text:""}],created_at:new Date().toISOString(),updated_at:new Date().toISOString(),parent_message_uuid:n.uuid,attachments:[],files:[],files_v2:[],sync_sources:[],index:1,metadata:{is_resume_completion_placeholder_message:!0}};d(t,[n,a]),I()}}},[s,n,a,k,E,d,t,I]),(0,c.useEffect)(()=>()=>{A()},[A]),{hasPendingUserMessage:x,isCompletionStatusLoading:!!n&&S&&!w,stopPendingRecovery:()=>b(!1)}}({conversationUuid:r,chatConversationTree:I,pendingUserMessage:z,isLoading:N});I||N||T||(0,p.notFound)();let ex=(0,c.useMemo)(()=>(null==I?void 0:I.settings)||{},[null==I?void 0:I.settings]);return(0,a.jsxs)(g.N,{settings:ex,children:[(0,a.jsx)(x.v,{isStreaming:em||e_,isTemporary:!!(null==i?void 0:i.is_temporary),chatInputDefaultMessage:A,conversationTitle:i?"".concat(i.name," - Claude"):"Claude",conversationUuid:r,isLoading:N||ey,messageUuids:K,name:null!=(l=null!=(n=null==I?void 0:I.name)?n:null==i?void 0:i.name)?l:"Untitled Chat",onSend:ef,onRetry:ev,projectUuid:O,changeDisplayedConversationPath:ep,editMessage:eg,setPersonalizedStyleCallback:el,onToolAllow:X,retryCount:ei,onStopSampling:e_?eh:void 0}),(0,a.jsx)(R,{isModalOpen:V,currentTool:G,currentToolInput:H,currentServer:W,handleDeny:Z,handleAllow:X,handleAlwaysAllow:$})]})}var K=n(71302),Q=n(16304);function Y(e){var t;let{uuid:n,q:o}=e,{data:u,currentPath:d,isLoading:c}=(0,s.Bq)(n);return(0,l.K7)(null!=(t=null==u?void 0:u.name)?t:""),(0,Q.V)(n,d||[],c),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.u,{conversationUuid:n,children:(0,a.jsx)(i._,{conversationUuid:n,children:(0,a.jsx)(B,{conversation:u,conversationUuid:n,chatInputDefaultMessage:o})})}),(0,a.jsx)(K.PaymentVerificationModal,{})]})}}}]);